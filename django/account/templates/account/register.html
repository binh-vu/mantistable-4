{% extends "account/login_register_base.html" %}
{% load static %}

{% block title %}
    Register |  {{ block.super }}
{% endblock %}

{% block sideColumnMainText %}
    Hello!
    {% if challenge %}
        <span class="small block">Want to join the challenge?</span>
        <span class="small block"> Create an account!</span>
    {% endif %}
{% endblock %}

{% block sideColumnCTA %}

    <p>Already have an account?</p>
    <a class="btn btn-outline-white" href="{% url 'login' %}">Sign IN</a>

{% endblock %}

{% block content %}
    {{ block.super }}

    <h1>
        Sign Up
    </h1>

    <form id="register-form" method="post" enctype="multipart/form-data" action="{% url 'register' %}">
        {% csrf_token %}

        {#TODO: move message below#}
        <div id="message-registration"></div>

        <div class="form-group material input-text">
            <input type="text" id="{{ registration_form.username.id_for_label }}"
                   name="username">
            <label for="{{ registration_form.username.id_for_label }}">Username</label>

            {#            <div class="form-hint">#}
            {#                {{ registration_form.username.help_text }}#}
            {#            </div>#}
            <div class="form-error-message">
                {{ registration_form.username.errors }}
            </div>

        </div>

        <div class="form-group material input-text">
            <input type="text" id="{{ registration_form.email.id_for_label }}"
                   name="email">
            <label for="{{ registration_form.email.id_for_label }}">Email</label>

            {#            <div class="form-hint">#}
            {#                {{ registration_form.email.help_text }}#}
            {#            </div>#}
            <div class="form-error-message">
                {{ registration_form.email.errors }}
            </div>

        </div>

        {#long-hint#}
        <div class="form-group material input-text ">
            <input type="password" id="{{ registration_form.password1.id_for_label }}"
                   name="password1">
            <label for="{{ registration_form.password1.id_for_label }}">Password</label>

            {#            <div class="form-hint">#}
            {#                {{ registration_form.password1.help_text }}#}
            {#            </div>#}
            <div class="form-error-message">
                {{ registration_form.password1.errors }}
            </div>

        </div>

        <div class="form-group material input-text">
            <input type="password" class="form-control" id="{{ registration_form.password2.id_for_label }}"
                   name="password2">
            <label for="{{ registration_form.password2.id_for_label }}">Password Confirmation</label>
            {#            <div class="form-hint">#}
            {#                {{ registration_form.password2.help_text }}#}
            {#            </div>#}
            <div class="form-error-message">
                {{ registration_form.password2.errors }}
            </div>
        </div>

        {% if registration_form.non_field_errors %}

            <div class="alert alert-danger" role="alert">
                {% for error in registration_form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>

        {% endif %}

        <div class="row">
            <div class="col col-md-9">
                <div class="form-group material input-file {% if image_form.avatar.errors %}error{% endif %}">
                    {{ image_form.avatar }}
                    {{ image_form.avatar.label_tag }}
                    <div class="form-error-message">


                        {#TODO: show error#}
                        {% if image_form.avatar.errors %}
                            <div class="error-message">
                                {% for error in image_form.avatar.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <div class="col col-md-3">
                {#TODO: serve static?#}
                <img class="profile-user-img img-fluid img-circle"
                     id="form-avatar"
                     src="/media/default_avatar.png"
                />
            </div>
        </div>

        <button class="btn btn-primary btn-lg loading-animation" type="submit">Sign up</button>
        <div class="global form-error-message"></div>

    </form>
{% endblock %}

{% block javascript %}
    {{ block.super }}

    <script>
        var loadFile = function (event) {
            var image = document.getElementById('form-avatar');
            image.src = URL.createObjectURL(event.target.files[0]);
        };

        $(document).ready(function () {

            /*submit form*/
            $("form#register-form").submit(function (e) {
                e.preventDefault();

                var form = $(this);
                var formData = new FormData(this);

                var usernameItem = $("#{{ registration_form.username.id_for_label  }}");
                var emailItem = $("#{{ registration_form.email.id_for_label  }}");
                var passwordItem = $("#{{registration_form.password1.id_for_label}}");
                var passwordConfirmItem = $("#{{ registration_form.password2.id_for_label }}");

                resetErrorsAndNotifications(form);

                const submitButton = $(this).find('.btn.loading-animation');
                $(submitButton).addClass('loading');
                $(submitButton).addClass('disabled');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        console.log(response);
                        $(submitButton).addClass('success');
                        $(submitButton).removeClass('disabled');

                        $("#message-registration").append($('<div class="alert alert-success" role="alert">Check your email to complete the registration</div>'));

                        //window.location.href = response['redirect'];
                    },
                    error: function (request) {
                        const data = request["responseJSON"];
                        console.log(data);
                        if (data) {
                            if ("username" in data) {
                                setErrorMessage($(usernameItem), data["username"][0]);
                            }

                            if ("email" in data) {
                                setErrorMessage($(emailItem), data["email"][0]);
                            }

                            if ("password1" in data) {
                                setErrorMessage($(passwordItem), data["password1"][0]);
                            }

                            if ("password2" in data) {
                                setErrorMessage($(passwordConfirmItem), data["password2"][0]);
                            }

                            if ("__all__" in data) {
                                $('.global.form-error-message').append(data["__all__"][0]).show();
                            }

                        }

                        $(submitButton).removeClass('disabled');
                    },
                    complete: function () {
                        $(submitButton).removeClass('loading');
                    },
                    async: true,
                    timeout: 60000,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

        });

    </script>
{% endblock %}
